# VBot 圆形竞技场导航任务 - 使用指南

## 快速开始

### 1. 基本运行

在10个并行环境中运行竞技场导航任务：

```bash
# 使用view脚本可视化10只机器狗的竞技场导航
cd /home/1ctnltug/Desktop/MotrixLab
python scripts/view.py --env vbot_navigation_section001 --num-envs 10
```

### 2. 测试验证

运行验证脚本确保所有功能正常：

```bash
python test_arena_navigation.py
```

预期输出：
```
================================================================================
VBot 圆形竞技场导航测试
================================================================================

[1] 创建环境...
    ✓ 环境创建成功 (10只机器狗)

[2] 初始化环境...
    ✓ 观测维度: (10, 54)
    ✓ 初始总分: 0.0/20.0
    ✓ 各狗初始分数: [0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
    ✓ 各狗阶段: [0 0 0 0 0 0 0 0 0 0]

[3] 验证初始化位置...
    ✓ 10只狗在外圈 (3.0-3.2m) 随机分布
    ✓ 起始位置完全随机，无固定位置

[4] 运行仿真循环 (100步)...
    Step  10: Total=  0.0/20.0 | Scores=[0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] | Stages=[0 0 0 0 0 0 0 0 0 0]
    ...
    Step 100: Total=  2.0/20.0 | Scores=[0. 1. 0. 0. 0. 0. 1. 0. 0. 0.] | Stages=[1 1 0 0 0 0 1 0 0 0]
    ✓ 仿真完成

[5] 仿真统计...
    最高总分: 2.0/20.0
    最终总分: 2.0/20.0
    得分曲线: 单调非递减

[6] 功能验证...
    ✓ 计分系统正常工作 (最高分: 2.0)
    ✓ 得分上限正确 (<= 20.0)
    ✓ 观测维度正确 (54维)
    ✓ 奖励维度正确 (10维，每只狗一个)

================================================================================
✓ 所有测试通过!
================================================================================
```

---

## 详细说明

### 环境参数

| 参数 | 值 | 说明 |
|------|-----|------|
| `--env` | `vbot_navigation_section001` | 环境名称（圆形竞技场导航） |
| `--num-envs` | `10` | 并行环境数（10只机器狗） |
| `--sim-backend` | `motrixsim`(默认) | 物理模拟引擎 |

### 实时监控指标

运行过程中可实时监控以下指标：

```python
# 来自 env.step() 的返回值
obs, reward, terminated, info = env.step(actions)

# 可用的计分信息
info["total_score"]      # 10只狗的总得分 (0-20)
info["dog_scores"]       # 每只狗的得分 (10维数组，每个0-2)
info["dog_stage"]        # 每只狗的阶段 (10维数组，值为0/1/2)

# 其他信息
info["pose_commands"]    # 当前目标位置
info["steps"]            # 每个环境的步数
```

---

## 竞技场参数说明

### 场景布局

```
┌─────────────────────────────────┐
│     圆形竞技场导航任务          │
└─────────────────────────────────┘

        起始区域 (外圈)
        半径: 3.0m
        ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲
    ▲ 10只机器狗随机分布      ▲
    ▲   (3.0-3.2m)              ▲
        ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲
            ↓
            ↓ 导航目标A (内圈)
            ↓ 半径: 1.5m
            ○ ← 触发点A (+1分)
            ↓
            ↓ 导航目标B (圆心)
            ↓
            ● ← 触发点B (+1分)

边界: 3.5m (越界则得分清零)
```

### 三阶段任务

```
┌─────────────────────────────────────────────┐
│ 阶段 0 → 1: 外圈 → 内圈 (触发点A)          │
│ ├─ 触发条件: 进入内圈半径0.3m范围           │
│ ├─ 得分: +1分                               │
│ └─ 目标点坐标: (0.0, 1.5m)                 │
├─────────────────────────────────────────────┤
│ 阶段 1 → 2: 内圈 → 圆心 (触发点B)          │
│ ├─ 触发条件: 进入圆心半径0.3m范围           │
│ ├─ 得分: +1分                               │
│ └─ 目标点坐标: (0.0, 0.0m)                 │
└─────────────────────────────────────────────┘
```

---

## 惩罚机制

### 得分清零条件

| 条件 | 判定标准 | 后果 |
|------|---------|------|
| **摔倒** | Roll或Pitch > 60° | 该狗得分清零 |
| **长时间悬空** | 所有足部接触 < 0.1 持续50帧 | 该狗得分清零 |
| **越界** | 距圆心 > 3.5m | 该狗得分清零 |

### 重要特性

- ✅ **独立计分**: 单只狗的失败不影响其他狗的得分
- ✅ **无法恢复**: 一旦被惩罚，该狗在本轮得分保持为0，直到重置
- ✅ **实时判定**: 每帧检查违规条件，立即清零

---

## 观测信息 (54维)

```
观测 = [
    线速度         (3维),      # 机体坐标系
    角速度         (3维),      # 陀螺仪
    投影重力       (3维),      # 机体坐标系中的重力向量
    关节位置       (12维),     # 相对于默认角度
    关节速度       (12维),     
    上一步动作     (12维),     
    速度命令       (3维),      # [vx, vy, wz] 归一化
    位置误差       (2维),      # [dx, dy] / 5.0
    朝向误差       (1维),      # dθ / π
    距离           (1维),      # 到目标距离
    到达标志       (1维),      # 是否到达目标
    停止就绪标志   (1维),      # 到达且静止
]
总计: 54维
```

---

## 动作空间

- **维度**: 12维
- **范围**: [-1.0, 1.0]
- **映射**: 每只腿的髋、大腿、小腿关节角度 (4腿 × 3关节)
- **执行方式**: PD控制器（kp=80, kv=6）

---

## 训练与测试

### 训练模式

```bash
# 使用RL框架训练
python scripts/train.py \
    --task vbot_navigation_section001 \
    --num-envs 10 \
    --max-iterations 1000
```

### 测试模式

```bash
# 加载训练好的模型进行推理
python scripts/play.py \
    --task vbot_navigation_section001 \
    --num-envs 10 \
    --model /path/to/checkpoint.pt
```

### 可视化模式

```bash
# 实时显示竞技场进展
python scripts/view.py \
    --env vbot_navigation_section001 \
    --num-envs 10 \
    --device cuda  # 可选: 使用GPU加速
```

---

## 常见问题 (FAQ)

### Q1: 如何修改并行环境数量？

**A**: 使用 `--num-envs` 参数：

```bash
python scripts/view.py --env vbot_navigation_section001 --num-envs 20
```

### Q2: 如何验证得分系统是否工作？

**A**: 运行测试脚本或检查 `info["total_score"]`：

```python
for step in range(1000):
    obs, reward, terminated, info = env.step(actions)
    print(f"Total Score: {info['total_score']:.1f}/20.0")
    if info['total_score'] > 0:
        print(f"Individual scores: {info['dog_scores']}")
        break
```

### Q3: 如何调试单只狗的行为？

**A**: 减少 `num_envs=1` 并监控该狗的信息：

```bash
python scripts/view.py --env vbot_navigation_section001 --num-envs 1
```

### Q4: 摔倒检测的标准是什么？

**A**: 两个条件之一满足即判定摔倒：
1. Roll或Pitch角 > 60°
2. 所有足部接触值 < 0.1 持续 50帧 (~0.5秒)

### Q5: 如何检查机器狗是否真的随机初始化？

**A**: 多次调用 reset() 并查看初始位置：

```python
for trial in range(5):
    obs, info = env.reset()
    # 可查看机器狗初始位置
    # 由于无法直接访问位置，可通过第一步的行为推断
```

---

## 性能优化建议

1. **GPU加速**: 使用 `--device cuda` 加快仿真
2. **环境数调整**: 
   - 小规模测试: `--num-envs 1-10`
   - 训练阶段: `--num-envs 256-2048`
   - 集群运行: 分多个进程，每个10-64环境
3. **回放缓冲区**: 如果需要采样历史数据，确保缓冲区大小足够

---

## 文件位置

```
MotrixLab/
├── motrix_envs/
│   └── src/motrix_envs/navigation/vbot/
│       ├── vbot_section001_np.py          # ← 主要实现文件
│       ├── cfg.py                          # ← 配置文件
│       └── xmls/
│           └── scene_section001.xml       # ← 场景定义
├── scripts/
│   ├── view.py                            # ← 可视化脚本
│   ├── train.py                           # ← 训练脚本
│   └── play.py                            # ← 推理脚本
├── test_arena_navigation.py               # ← 验证脚本
└── IMPLEMENTATION_SUMMARY.md              # ← 详细说明
```

---

## 相关资源

- Motphys 物理引擎: [官方文档]
- VBot 机器人模型: `motrix_envs/src/motrix_envs/navigation/vbot/xmls/vbot.xml`
- 导航任务配置: `motrix_envs/src/motrix_envs/navigation/vbot/cfg.py`

---

## 反馈与改进

如有问题或建议，请查阅：
- `IMPLEMENTATION_SUMMARY.md` - 完整的技术文档
- `vbot_section001_np.py` - 源代码注释
- `test_arena_navigation.py` - 测试用例示例
